{"version":3,"file":"RealLogViewer.esm.js","sources":["../../../src/components/LogViewer/RealLogViewer.tsx"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport Box from '@material-ui/core/Box';\nimport IconButton from '@material-ui/core/IconButton';\nimport CopyIcon from '@material-ui/icons/FileCopy';\nimport classnames from 'classnames';\nimport { useEffect, useMemo, useRef, useState } from 'react';\nimport { useLocation } from 'react-router-dom';\nimport AutoSizer from 'react-virtualized-auto-sizer';\nimport { FixedSizeList, VariableSizeList } from 'react-window';\n\nimport { AnsiLine, AnsiProcessor } from './AnsiProcessor';\nimport { LogLine } from './LogLine';\nimport { LogViewerControls } from './LogViewerControls';\nimport { HEADER_SIZE, useStyles } from './styles';\nimport { useLogViewerSearch } from './useLogViewerSearch';\nimport { useLogViewerSelection } from './useLogViewerSelection';\nimport Snackbar from '@material-ui/core/Snackbar';\n\nexport interface RealLogViewerProps {\n  text: string;\n  textWrap?: boolean;\n  classes?: { root?: string };\n}\n\nexport function RealLogViewer(props: RealLogViewerProps) {\n  const classes = useStyles({ classes: props.classes });\n  const [listInstance, setListInstance] = useState<\n    VariableSizeList<AnsiLine[]> | FixedSizeList<AnsiLine[]> | null\n  >(null);\n  const shouldTextWrap = props.textWrap ?? false;\n  const heights = useRef<{ [key: number]: number }>({});\n\n  // The processor keeps state that optimizes appending to the text\n  const processor = useMemo(() => new AnsiProcessor(), []);\n  const lines = processor.process(props.text);\n  const [showCopyInfo, setShowCopyInfo] = useState(false);\n\n  const search = useLogViewerSearch(lines);\n  const selection = useLogViewerSelection(lines);\n  const location = useLocation();\n\n  useEffect(() => {\n    if (listInstance) {\n      listInstance.scrollToItem(lines.length - 1, 'end');\n    }\n  }, [listInstance, lines]);\n\n  useEffect(() => {\n    if (!listInstance) {\n      return;\n    }\n    if (search.resultLine) {\n      listInstance.scrollToItem(search.resultLine - 1, 'center');\n    } else {\n      listInstance.scrollToItem(lines.length - 1, 'end');\n    }\n  }, [listInstance, search.resultLine, lines]);\n\n  useEffect(() => {\n    const hash = selection.getHash();\n    if (hash.length > 0) {\n      history.replaceState(null, '', hash);\n    }\n  }, [selection]);\n\n  useEffect(() => {\n    if (location.hash) {\n      selection.selectAll(location.hash);\n    }\n  }, []); // eslint-disable-line react-hooks/exhaustive-deps\n\n  const handleSelectLine = (\n    line: number,\n    event: {\n      shiftKey: boolean;\n      metaKey: boolean;\n      ctrlKey: boolean;\n      preventDefault: () => void;\n    },\n  ) => {\n    event.preventDefault();\n    selection.setSelection(\n      line,\n      event.shiftKey,\n      event.metaKey || event.ctrlKey,\n    );\n  };\n\n  const handleCopySelection = (line: number) => {\n    selection.copySelection(line);\n    setShowCopyInfo(true);\n  };\n\n  function setRowHeight(index: number, size: number) {\n    if (shouldTextWrap && listInstance) {\n      (listInstance as VariableSizeList<AnsiLine[]>).resetAfterIndex(0);\n      // lineNumber is 1-based but index is 0-based\n      heights.current[index - 1] = size;\n    }\n  }\n\n  function getRowHeight(index: number) {\n    return heights.current[index] || 20;\n  }\n\n  return (\n    <>\n      <AutoSizer>\n        {({ height, width }: { height?: number; width?: number }) => {\n          const commonProps = {\n            ref: setListInstance,\n            className: classes.log,\n            height: (height || 480) - HEADER_SIZE,\n            width: width || 640,\n            itemData: search.lines,\n            itemCount: search.lines.length,\n          };\n\n          const renderItem = ({\n            index,\n            style,\n            data,\n          }: {\n            index: number;\n            style: React.CSSProperties;\n            data: AnsiLine[];\n          }) => {\n            const line = data[index];\n            const { lineNumber } = line;\n            return (\n              <Box\n                style={{ ...style }}\n                className={classnames(classes.line, {\n                  [classes.lineSelected]: selection.isSelected(lineNumber),\n                })}\n              >\n                {selection.shouldShowCopyButton(lineNumber) && (\n                  <IconButton\n                    data-testid=\"copy-button\"\n                    size=\"small\"\n                    className={classes.lineCopyButton}\n                    onClick={() => handleCopySelection(lineNumber)}\n                  >\n                    <CopyIcon fontSize=\"inherit\" />\n                  </IconButton>\n                )}\n                <a\n                  role=\"row\"\n                  target=\"_self\"\n                  href={`#line-${lineNumber}`}\n                  className={classes.lineNumber}\n                  onClick={event => handleSelectLine(lineNumber, event)}\n                  onKeyPress={event => handleSelectLine(lineNumber, event)}\n                >\n                  {lineNumber}\n                </a>\n                <LogLine\n                  setRowHeight={shouldTextWrap ? setRowHeight : undefined}\n                  line={line}\n                  classes={classes}\n                  searchText={search.searchText}\n                  highlightResultIndex={\n                    search.resultLine === lineNumber\n                      ? search.resultLineIndex\n                      : undefined\n                  }\n                />\n              </Box>\n            );\n          };\n\n          return (\n            <Box style={{ width, height }} className={classes.root}>\n              <Box className={classes.header}>\n                <LogViewerControls {...search} />\n              </Box>\n              {shouldTextWrap ? (\n                <VariableSizeList<AnsiLine[]>\n                  {...commonProps}\n                  itemSize={getRowHeight}\n                >\n                  {renderItem}\n                </VariableSizeList>\n              ) : (\n                <FixedSizeList<AnsiLine[]> {...commonProps} itemSize={20}>\n                  {renderItem}\n                </FixedSizeList>\n              )}\n            </Box>\n          );\n        }}\n      </AutoSizer>\n      <Snackbar\n        open={showCopyInfo}\n        autoHideDuration={3000}\n        onClose={() => setShowCopyInfo(false)}\n        message=\"Lines copied to clipboard\"\n        anchorOrigin={{ vertical: 'bottom', horizontal: 'center' }}\n      />\n    </>\n  );\n}\n"],"names":["classnames"],"mappings":"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"}
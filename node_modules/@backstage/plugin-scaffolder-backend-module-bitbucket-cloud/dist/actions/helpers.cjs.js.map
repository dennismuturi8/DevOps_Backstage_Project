{"version":3,"file":"helpers.cjs.js","sources":["../../src/actions/helpers.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Bitbucket } from 'bitbucket';\nimport { getBitbucketCloudOAuthToken } from '@backstage/integration';\n\nexport const getBitbucketClient = async (config: {\n  token?: string;\n  username?: string;\n  appPassword?: string;\n  clientId?: string;\n  clientSecret?: string;\n}) => {\n  // If OAuth credentials provided, fetch token\n  if (config.clientId && config.clientSecret) {\n    const token = await getBitbucketCloudOAuthToken(\n      config.clientId,\n      config.clientSecret,\n    );\n    return new Bitbucket({\n      auth: {\n        token,\n      },\n    });\n  }\n\n  if (config.token) {\n    return new Bitbucket({\n      auth: {\n        token: config.token,\n      },\n    });\n  } else if (config.username && config.appPassword) {\n    // TODO: appPassword can be removed once fully\n    // deprecated by BitBucket on 9th June 2026.\n    return new Bitbucket({\n      auth: {\n        username: config.username,\n        password: config.appPassword,\n      },\n    });\n  }\n  throw new Error(\n    `Authorization has not been provided for Bitbucket Cloud. Please provide either OAuth credentials (clientId/clientSecret), username and token, or username and appPassword in the Integrations config`,\n  );\n};\n\nexport const getAuthorizationHeader = async (config: {\n  username?: string;\n  appPassword?: string;\n  token?: string;\n  clientId?: string;\n  clientSecret?: string;\n}): Promise<string> => {\n  // OAuth authentication\n  if (config.clientId && config.clientSecret) {\n    const token = await getBitbucketCloudOAuthToken(\n      config.clientId,\n      config.clientSecret,\n    );\n    return `Bearer ${token}`;\n  }\n\n  // TODO: appPassword can be removed once fully\n  // deprecated by BitBucket on 9th June 2026.\n  if (config.username && (config.token ?? config.appPassword)) {\n    const buffer = Buffer.from(\n      `${config.username}:${config.token ?? config.appPassword}`,\n      'utf8',\n    );\n    return `Basic ${buffer.toString('base64')}`;\n  }\n\n  if (config.token) {\n    return `Bearer ${config.token}`;\n  }\n\n  throw new Error(\n    `Authorization has not been provided for Bitbucket Cloud. Please provide either OAuth credentials (clientId/clientSecret), username and token, or username and appPassword in the Integrations config`,\n  );\n};\n"],"names":["getBitbucketCloudOAuthToken","Bitbucket"],"mappings":";;;;;AAmBO,MAAM,kBAAA,GAAqB,OAAO,MAAA,KAMnC;AAEJ,EAAA,IAAI,MAAA,CAAO,QAAA,IAAY,MAAA,CAAO,YAAA,EAAc;AAC1C,IAAA,MAAM,QAAQ,MAAMA,uCAAA;AAAA,MAClB,MAAA,CAAO,QAAA;AAAA,MACP,MAAA,CAAO;AAAA,KACT;AACA,IAAA,OAAO,IAAIC,mBAAA,CAAU;AAAA,MACnB,IAAA,EAAM;AAAA,QACJ;AAAA;AACF,KACD,CAAA;AAAA,EACH;AAEA,EAAA,IAAI,OAAO,KAAA,EAAO;AAChB,IAAA,OAAO,IAAIA,mBAAA,CAAU;AAAA,MACnB,IAAA,EAAM;AAAA,QACJ,OAAO,MAAA,CAAO;AAAA;AAChB,KACD,CAAA;AAAA,EACH,CAAA,MAAA,IAAW,MAAA,CAAO,QAAA,IAAY,MAAA,CAAO,WAAA,EAAa;AAGhD,IAAA,OAAO,IAAIA,mBAAA,CAAU;AAAA,MACnB,IAAA,EAAM;AAAA,QACJ,UAAU,MAAA,CAAO,QAAA;AAAA,QACjB,UAAU,MAAA,CAAO;AAAA;AACnB,KACD,CAAA;AAAA,EACH;AACA,EAAA,MAAM,IAAI,KAAA;AAAA,IACR,CAAA,oMAAA;AAAA,GACF;AACF;AAEO,MAAM,sBAAA,GAAyB,OAAO,MAAA,KAMtB;AAErB,EAAA,IAAI,MAAA,CAAO,QAAA,IAAY,MAAA,CAAO,YAAA,EAAc;AAC1C,IAAA,MAAM,QAAQ,MAAMD,uCAAA;AAAA,MAClB,MAAA,CAAO,QAAA;AAAA,MACP,MAAA,CAAO;AAAA,KACT;AACA,IAAA,OAAO,UAAU,KAAK,CAAA,CAAA;AAAA,EACxB;AAIA,EAAA,IAAI,MAAA,CAAO,QAAA,KAAa,MAAA,CAAO,KAAA,IAAS,OAAO,WAAA,CAAA,EAAc;AAC3D,IAAA,MAAM,SAAS,MAAA,CAAO,IAAA;AAAA,MACpB,GAAG,MAAA,CAAO,QAAQ,IAAI,MAAA,CAAO,KAAA,IAAS,OAAO,WAAW,CAAA,CAAA;AAAA,MACxD;AAAA,KACF;AACA,IAAA,OAAO,CAAA,MAAA,EAAS,MAAA,CAAO,QAAA,CAAS,QAAQ,CAAC,CAAA,CAAA;AAAA,EAC3C;AAEA,EAAA,IAAI,OAAO,KAAA,EAAO;AAChB,IAAA,OAAO,CAAA,OAAA,EAAU,OAAO,KAAK,CAAA,CAAA;AAAA,EAC/B;AAEA,EAAA,MAAM,IAAI,KAAA;AAAA,IACR,CAAA,oMAAA;AAAA,GACF;AACF;;;;;"}
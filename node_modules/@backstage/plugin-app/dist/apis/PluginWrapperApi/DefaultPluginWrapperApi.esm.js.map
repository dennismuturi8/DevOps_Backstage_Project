{"version":3,"file":"DefaultPluginWrapperApi.esm.js","sources":["../../../src/apis/PluginWrapperApi/DefaultPluginWrapperApi.tsx"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { PluginWrapperApi } from '@backstage/frontend-plugin-api/alpha';\nimport { ComponentType, ReactNode, useEffect, useMemo, useState } from 'react';\n\ntype WrapperInput = {\n  loader: () => Promise<{ component: ComponentType<{ children: ReactNode }> }>;\n  pluginId: string;\n};\n\n/**\n * Default implementation of PluginWrapperApi.\n *\n * @internal\n */\nexport class DefaultPluginWrapperApi implements PluginWrapperApi {\n  constructor(\n    private readonly pluginWrappers: Map<\n      string,\n      ComponentType<{ children: ReactNode }>\n    >,\n  ) {}\n\n  getPluginWrapper(\n    pluginId: string,\n  ): ComponentType<{ children: ReactNode }> | undefined {\n    return this.pluginWrappers.get(pluginId);\n  }\n\n  static fromWrappers(wrappers: Array<WrapperInput>): DefaultPluginWrapperApi {\n    const loadersByPlugin = new Map<\n      string,\n      Array<\n        () => Promise<{ component: ComponentType<{ children: ReactNode }> }>\n      >\n    >();\n\n    for (const wrapper of wrappers) {\n      let loaders = loadersByPlugin.get(wrapper.pluginId);\n      if (!loaders) {\n        loaders = [];\n        loadersByPlugin.set(wrapper.pluginId, loaders);\n      }\n      loaders.push(wrapper.loader);\n    }\n\n    const composedWrappers = new Map<\n      string,\n      ComponentType<{ children: ReactNode }>\n    >();\n\n    for (const [pluginId, loaders] of loadersByPlugin) {\n      if (loaders.length === 0) {\n        continue;\n      }\n\n      const ComposedWrapper = (props: { children: ReactNode }) => {\n        const [loadedWrappers, setLoadedWrappers] = useState<\n          Array<ComponentType<{ children: ReactNode }>> | undefined\n        >(undefined);\n        const [error, setError] = useState<Error | undefined>(undefined);\n\n        useEffect(() => {\n          Promise.all(loaders.map(loader => loader()))\n            .then(results => {\n              setLoadedWrappers(results.map(r => r.component));\n            })\n            .catch(setError);\n        }, []);\n\n        if (error) {\n          throw error;\n        }\n\n        return useMemo(() => {\n          if (!loadedWrappers) {\n            return null;\n          }\n\n          let current = props.children;\n\n          for (const Wrapper of loadedWrappers) {\n            current = <Wrapper>{current}</Wrapper>;\n          }\n\n          return current;\n        }, [loadedWrappers, props.children]);\n      };\n\n      composedWrappers.set(pluginId, ComposedWrapper);\n    }\n\n    return new DefaultPluginWrapperApi(composedWrappers);\n  }\n}\n"],"names":[],"mappings":";;;AA6BO,MAAM,uBAAA,CAAoD;AAAA,EAC/D,YACmB,cAAA,EAIjB;AAJiB,IAAA,IAAA,CAAA,cAAA,GAAA,cAAA;AAAA,EAIhB;AAAA,EAEH,iBACE,QAAA,EACoD;AACpD,IAAA,OAAO,IAAA,CAAK,cAAA,CAAe,GAAA,CAAI,QAAQ,CAAA;AAAA,EACzC;AAAA,EAEA,OAAO,aAAa,QAAA,EAAwD;AAC1E,IAAA,MAAM,eAAA,uBAAsB,GAAA,EAK1B;AAEF,IAAA,KAAA,MAAW,WAAW,QAAA,EAAU;AAC9B,MAAA,IAAI,OAAA,GAAU,eAAA,CAAgB,GAAA,CAAI,OAAA,CAAQ,QAAQ,CAAA;AAClD,MAAA,IAAI,CAAC,OAAA,EAAS;AACZ,QAAA,OAAA,GAAU,EAAC;AACX,QAAA,eAAA,CAAgB,GAAA,CAAI,OAAA,CAAQ,QAAA,EAAU,OAAO,CAAA;AAAA,MAC/C;AACA,MAAA,OAAA,CAAQ,IAAA,CAAK,QAAQ,MAAM,CAAA;AAAA,IAC7B;AAEA,IAAA,MAAM,gBAAA,uBAAuB,GAAA,EAG3B;AAEF,IAAA,KAAA,MAAW,CAAC,QAAA,EAAU,OAAO,CAAA,IAAK,eAAA,EAAiB;AACjD,MAAA,IAAI,OAAA,CAAQ,WAAW,CAAA,EAAG;AACxB,QAAA;AAAA,MACF;AAEA,MAAA,MAAM,eAAA,GAAkB,CAAC,KAAA,KAAmC;AAC1D,QAAA,MAAM,CAAC,cAAA,EAAgB,iBAAiB,CAAA,GAAI,SAE1C,MAAS,CAAA;AACX,QAAA,MAAM,CAAC,KAAA,EAAO,QAAQ,CAAA,GAAI,SAA4B,MAAS,CAAA;AAE/D,QAAA,SAAA,CAAU,MAAM;AACd,UAAA,OAAA,CAAQ,GAAA,CAAI,QAAQ,GAAA,CAAI,CAAA,MAAA,KAAU,QAAQ,CAAC,CAAA,CACxC,IAAA,CAAK,CAAA,OAAA,KAAW;AACf,YAAA,iBAAA,CAAkB,OAAA,CAAQ,GAAA,CAAI,CAAA,CAAA,KAAK,CAAA,CAAE,SAAS,CAAC,CAAA;AAAA,UACjD,CAAC,CAAA,CACA,KAAA,CAAM,QAAQ,CAAA;AAAA,QACnB,CAAA,EAAG,EAAE,CAAA;AAEL,QAAA,IAAI,KAAA,EAAO;AACT,UAAA,MAAM,KAAA;AAAA,QACR;AAEA,QAAA,OAAO,QAAQ,MAAM;AACnB,UAAA,IAAI,CAAC,cAAA,EAAgB;AACnB,YAAA,OAAO,IAAA;AAAA,UACT;AAEA,UAAA,IAAI,UAAU,KAAA,CAAM,QAAA;AAEpB,UAAA,KAAA,MAAW,WAAW,cAAA,EAAgB;AACpC,YAAA,OAAA,mBAAU,GAAA,CAAC,WAAS,QAAA,EAAA,OAAA,EAAQ,CAAA;AAAA,UAC9B;AAEA,UAAA,OAAO,OAAA;AAAA,QACT,CAAA,EAAG,CAAC,cAAA,EAAgB,KAAA,CAAM,QAAQ,CAAC,CAAA;AAAA,MACrC,CAAA;AAEA,MAAA,gBAAA,CAAiB,GAAA,CAAI,UAAU,eAAe,CAAA;AAAA,IAChD;AAEA,IAAA,OAAO,IAAI,wBAAwB,gBAAgB,CAAA;AAAA,EACrD;AACF;;;;"}
{"version":3,"file":"usePageCache.esm.js","sources":["../../../../src/components/Table/hooks/usePageCache.ts"],"sourcesContent":["/*\n * Copyright 2025 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { useState, useCallback, useRef, useEffect } from 'react';\n\nconst FIRST_PAGE_CURSOR = Symbol('firstPage');\n\ntype CursorType = string | number;\n\ntype InternalCursor<TCursor extends CursorType> =\n  | TCursor\n  | typeof FIRST_PAGE_CURSOR;\n\ninterface PageEntry<T, TCursor extends CursorType> {\n  data: T[] | undefined;\n  nextCursor: InternalCursor<TCursor> | undefined;\n  prevCursor: InternalCursor<TCursor> | undefined;\n}\n\ninterface GetDataResult<T, TCursor extends CursorType> {\n  data: T[];\n  nextCursor?: TCursor;\n  prevCursor?: TCursor;\n  totalCount?: number;\n}\n\n/** @internal */\nexport interface UsePageCacheOptions<T, TCursor extends CursorType = string> {\n  getData: (params: {\n    cursor: TCursor | undefined;\n    signal: AbortSignal;\n  }) => Promise<GetDataResult<T, TCursor>>;\n  initialCurrentCursor?: TCursor;\n}\n\n/** @internal */\nexport interface UsePageCacheResult<T, TCursor extends CursorType = string> {\n  loading: boolean;\n  error: Error | undefined;\n  data: T[] | undefined;\n  totalCount: number | undefined;\n  currentCursor: TCursor | undefined;\n  hasPreviousPage: boolean;\n  onPreviousPage: () => void;\n  hasNextPage: boolean;\n  onNextPage: () => void;\n  reload: (options?: { keepCurrentCursor?: boolean }) => void;\n}\n\ntype Direction = 'mount' | 'reset' | 'refresh' | 'next' | 'prev';\n\nclass PageCacheStore<T, TCursor extends CursorType> {\n  private cache = new Map<InternalCursor<TCursor>, PageEntry<T, TCursor>>();\n\n  get(cursor: InternalCursor<TCursor>): PageEntry<T, TCursor> | undefined {\n    return this.cache.get(cursor);\n  }\n\n  getOrCreate(cursor: InternalCursor<TCursor>): PageEntry<T, TCursor> {\n    const existing = this.cache.get(cursor);\n    if (existing) {\n      return existing;\n    }\n    const entry: PageEntry<T, TCursor> = {\n      data: undefined,\n      nextCursor: undefined,\n      prevCursor: undefined,\n    };\n    this.cache.set(cursor, entry);\n    return entry;\n  }\n\n  clear() {\n    this.cache.clear();\n  }\n\n  getTargetCursor(\n    direction: Direction,\n    currentCursor: InternalCursor<TCursor>,\n    initialCurrentCursor: TCursor | undefined,\n  ): InternalCursor<TCursor> | undefined {\n    if (direction === 'mount') {\n      return toInternalCursor(initialCurrentCursor);\n    }\n    if (direction === 'reset') {\n      return FIRST_PAGE_CURSOR;\n    }\n    if (direction === 'refresh') {\n      return currentCursor;\n    }\n    const currentEntry = this.cache.get(currentCursor);\n\n    if (!currentEntry) {\n      return;\n    }\n\n    return direction === 'next'\n      ? currentEntry.nextCursor\n      : currentEntry.prevCursor;\n  }\n\n  linkEntryToSource(\n    entry: PageEntry<T, TCursor>,\n    direction: Direction,\n    currentCursor: InternalCursor<TCursor>,\n  ) {\n    if (direction === 'next') {\n      entry.prevCursor = currentCursor;\n    } else if (direction === 'prev') {\n      entry.nextCursor = currentCursor;\n    }\n  }\n}\n\nfunction toInternalCursor<TCursor extends CursorType>(\n  cursor: TCursor | undefined,\n): InternalCursor<TCursor> {\n  return cursor === undefined ? FIRST_PAGE_CURSOR : cursor;\n}\n\nfunction toExternalCursor<TCursor extends CursorType>(\n  cursor: InternalCursor<TCursor>,\n): TCursor | undefined {\n  return cursor === FIRST_PAGE_CURSOR ? undefined : cursor;\n}\n\n/** @internal */\nexport function usePageCache<T, TCursor extends CursorType = string>(\n  options: UsePageCacheOptions<T, TCursor>,\n): UsePageCacheResult<T, TCursor> {\n  const { getData, initialCurrentCursor } = options;\n\n  const [currentCursor, setCurrentCursor] = useState<InternalCursor<TCursor>>(\n    () => toInternalCursor(initialCurrentCursor),\n  );\n\n  const cacheStore = useRef(new PageCacheStore<T, TCursor>()).current;\n\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<Error | undefined>(undefined);\n  const [totalCount, setTotalCount] = useState<number | undefined>(undefined);\n\n  const abortControllerRef = useRef<AbortController | null>(null);\n\n  const currentPage = cacheStore.get(currentCursor);\n  const data = currentPage?.data;\n  const hasNextPage = currentPage?.nextCursor !== undefined;\n  const hasPreviousPage = currentPage?.prevCursor !== undefined;\n\n  const goToPage = useCallback(\n    async (direction: Direction) => {\n      const targetCursor = cacheStore.getTargetCursor(\n        direction,\n        currentCursor,\n        initialCurrentCursor,\n      );\n\n      if (!targetCursor) {\n        return;\n      }\n\n      const existingEntry = cacheStore.get(targetCursor);\n      if (existingEntry?.data !== undefined) {\n        setCurrentCursor(targetCursor);\n        return;\n      }\n\n      const entry = cacheStore.getOrCreate(targetCursor);\n      cacheStore.linkEntryToSource(entry, direction, currentCursor);\n      setCurrentCursor(targetCursor);\n\n      if (abortControllerRef.current) {\n        abortControllerRef.current.abort();\n      }\n\n      const abortController = new AbortController();\n      abortControllerRef.current = abortController;\n\n      setLoading(true);\n      setError(undefined);\n\n      try {\n        const result = await getData({\n          cursor: toExternalCursor(targetCursor),\n          signal: abortController.signal,\n        });\n\n        if (abortController.signal.aborted) {\n          return;\n        }\n\n        entry.data = result.data;\n\n        if (entry.nextCursor === undefined && result.nextCursor !== undefined) {\n          entry.nextCursor = result.nextCursor;\n        }\n        if (entry.prevCursor === undefined && result.prevCursor !== undefined) {\n          entry.prevCursor = result.prevCursor;\n        }\n\n        if (result.totalCount !== undefined) {\n          setTotalCount(result.totalCount);\n        }\n\n        setLoading(false);\n      } catch (err) {\n        if (abortController.signal.aborted) {\n          return;\n        }\n\n        setError(err instanceof Error ? err : new Error(String(err)));\n        setLoading(false);\n      }\n    },\n    [getData, initialCurrentCursor, currentCursor, cacheStore],\n  );\n\n  useEffect(() => {\n    goToPage('mount');\n\n    return () => {\n      if (abortControllerRef.current) {\n        abortControllerRef.current.abort();\n      }\n    };\n  }, []);\n\n  const onNextPage = useCallback(() => {\n    if (loading) return;\n    const page = cacheStore.get(currentCursor);\n    if (!page?.nextCursor) return;\n    goToPage('next');\n  }, [loading, currentCursor, goToPage, cacheStore]);\n\n  const onPreviousPage = useCallback(() => {\n    if (loading) return;\n    const page = cacheStore.get(currentCursor);\n    if (!page?.prevCursor) return;\n    goToPage('prev');\n  }, [loading, currentCursor, goToPage, cacheStore]);\n\n  const reload = useCallback(\n    (reloadOptions?: { keepCurrentCursor?: boolean }) => {\n      if (abortControllerRef.current) {\n        abortControllerRef.current.abort();\n      }\n\n      cacheStore.clear();\n\n      goToPage(reloadOptions?.keepCurrentCursor ? 'refresh' : 'reset');\n    },\n    [goToPage, cacheStore],\n  );\n\n  return {\n    loading,\n    error,\n    data,\n    totalCount,\n    currentCursor: toExternalCursor(currentCursor),\n    hasPreviousPage,\n    onPreviousPage,\n    hasNextPage,\n    onNextPage,\n    reload,\n  };\n}\n"],"names":[],"mappings":"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"}
{"version":3,"file":"DefaultRootSystemMetadataService.cjs.js","sources":["../../../../../src/alpha/entrypoints/rootSystemMetadata/lib/DefaultRootSystemMetadataService.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  LoggerService,\n  RootConfigService,\n  RootInstanceMetadataService,\n} from '@backstage/backend-plugin-api';\nimport {\n  RootSystemMetadataService,\n  RootSystemMetadataServicePluginInfo,\n} from '@backstage/backend-plugin-api/alpha';\nimport { getEndpoints } from '../../../../entrypoints/discovery/parsing';\nimport { Config } from '@backstage/config';\n\nfunction getPlugins(config: Config): string[] {\n  const endpoints = getEndpoints(config);\n  return Array.from(new Set(endpoints.flatMap(endpoint => endpoint.plugins)));\n}\n\n/**\n * @alpha\n */\nexport class DefaultRootSystemMetadataService\n  implements RootSystemMetadataService\n{\n  #plugins: string[];\n  #instanceMetadata: RootInstanceMetadataService;\n  constructor(options: {\n    logger: LoggerService;\n    config: RootConfigService;\n    instanceMetadata: RootInstanceMetadataService;\n  }) {\n    const { config } = options;\n    this.#plugins = getPlugins(config);\n    config.subscribe?.(() => {\n      this.#plugins = getPlugins(config);\n    });\n    this.#instanceMetadata = options.instanceMetadata;\n  }\n\n  public static create(pluginEnv: {\n    logger: LoggerService;\n    config: RootConfigService;\n    instanceMetadata: RootInstanceMetadataService;\n  }) {\n    return new DefaultRootSystemMetadataService(pluginEnv);\n  }\n\n  public async getInstalledPlugins(): Promise<\n    RootSystemMetadataServicePluginInfo[]\n  > {\n    const plugins = this.#plugins.map(pluginId => ({ pluginId }));\n\n    for (const plugin of await this.#instanceMetadata.getInstalledPlugins()) {\n      plugins.push({ pluginId: plugin.pluginId });\n    }\n\n    return plugins;\n  }\n}\n"],"names":["getEndpoints"],"mappings":";;;;AA4BA,SAAS,WAAW,MAAA,EAA0B;AAC5C,EAAA,MAAM,SAAA,GAAYA,qBAAa,MAAM,CAAA;AACrC,EAAA,OAAO,KAAA,CAAM,IAAA,CAAK,IAAI,GAAA,CAAI,SAAA,CAAU,QAAQ,CAAA,QAAA,KAAY,QAAA,CAAS,OAAO,CAAC,CAAC,CAAA;AAC5E;AAKO,MAAM,gCAAA,CAEb;AAAA,EACE,QAAA;AAAA,EACA,iBAAA;AAAA,EACA,YAAY,OAAA,EAIT;AACD,IAAA,MAAM,EAAE,QAAO,GAAI,OAAA;AACnB,IAAA,IAAA,CAAK,QAAA,GAAW,WAAW,MAAM,CAAA;AACjC,IAAA,MAAA,CAAO,YAAY,MAAM;AACvB,MAAA,IAAA,CAAK,QAAA,GAAW,WAAW,MAAM,CAAA;AAAA,IACnC,CAAC,CAAA;AACD,IAAA,IAAA,CAAK,oBAAoB,OAAA,CAAQ,gBAAA;AAAA,EACnC;AAAA,EAEA,OAAc,OAAO,SAAA,EAIlB;AACD,IAAA,OAAO,IAAI,iCAAiC,SAAS,CAAA;AAAA,EACvD;AAAA,EAEA,MAAa,mBAAA,GAEX;AACA,IAAA,MAAM,UAAU,IAAA,CAAK,QAAA,CAAS,IAAI,CAAA,QAAA,MAAa,EAAE,UAAS,CAAE,CAAA;AAE5D,IAAA,KAAA,MAAW,MAAA,IAAU,MAAM,IAAA,CAAK,iBAAA,CAAkB,qBAAoB,EAAG;AACvE,MAAA,OAAA,CAAQ,IAAA,CAAK,EAAE,QAAA,EAAU,MAAA,CAAO,UAAU,CAAA;AAAA,IAC5C;AAEA,IAAA,OAAO,OAAA;AAAA,EACT;AACF;;;;"}
"use strict";
/**
 * The following code is modified based on
 * https://github.com/webpack/webpack-dev-server
 *
 * MIT Licensed
 * Author Tobias Koppers @sokra
 * Copyright (c) JS Foundation and other contributors
 * https://github.com/webpack/webpack-dev-server/blob/main/LICENSE
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const ws_1 = __importDefault(require("ws"));
const BaseServer_1 = __importDefault(require("./BaseServer"));
class WebsocketServer extends BaseServer_1.default {
    constructor(server) {
        super(server);
        const options = {
            ...this.server.options.webSocketServer
                .options,
            clientTracking: false,
        };
        const isNoServerMode = typeof options.port === 'undefined' &&
            typeof options.server === 'undefined';
        if (isNoServerMode) {
            options.noServer = true;
        }
        this.implementation = new ws_1.default.Server(options);
        this.server.server.on('upgrade', (req, sock, head) => {
            if (!this.implementation.shouldHandle(req)) {
                return;
            }
            this.implementation.handleUpgrade(req, sock, head, (connection) => {
                this.implementation.emit('connection', connection, req);
            });
        });
        this.implementation.on('error', (err) => {
            this.server.logger.error(err.message);
        });
        const interval = setInterval(() => {
            for (const client of this.clients) {
                if (client.isAlive === false) {
                    client.terminate();
                    continue;
                }
                client.isAlive = false;
                client.ping(() => { });
            }
        }, WebsocketServer.heartbeatInterval);
        this.implementation.on('connection', (client) => {
            this.clients.push(client);
            client.isAlive = true;
            client.on('pong', () => {
                client.isAlive = true;
            });
            client.on('close', () => {
                this.clients.splice(this.clients.indexOf(client), 1);
            });
            // TODO: add a test case for this - https://github.com/webpack/webpack-dev-server/issues/5018
            client.on('error', (err) => {
                this.server.logger.error(err.message);
            });
        });
        this.implementation.on('close', () => {
            clearInterval(interval);
        });
    }
}
WebsocketServer.heartbeatInterval = 1000;
module.exports = WebsocketServer;

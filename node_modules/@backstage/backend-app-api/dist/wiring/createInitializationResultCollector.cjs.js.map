{"version":3,"file":"createInitializationResultCollector.cjs.js","sources":["../../src/wiring/createInitializationResultCollector.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { RootLoggerService } from '@backstage/backend-plugin-api';\nimport { AllowBootFailurePredicate } from './createAllowBootFailurePredicate';\nimport {\n  BackendStartupResult,\n  PluginStartupResult,\n  ModuleStartupResult,\n} from './types';\n\nconst LOGGER_INTERVAL_MAX = 60_000;\n\nfunction joinIds(ids: Iterable<string>): string {\n  return [...ids].map(id => `'${id}'`).join(', ');\n}\n\nexport function createInitializationResultCollector(options: {\n  pluginIds: string[];\n  logger?: RootLoggerService;\n  allowBootFailurePredicate: AllowBootFailurePredicate;\n}): {\n  onPluginResult(pluginId: string, error?: Error): void;\n  onPluginModuleResult(pluginId: string, moduleId: string, error?: Error): void;\n  finalize(): BackendStartupResult;\n} {\n  const logger = options.logger?.child({ type: 'initialization' });\n  const beginAt = new Date();\n  const starting = new Set(options.pluginIds.toSorted());\n  const started = new Set<string>();\n\n  let hasDisallowedFailures = false;\n\n  const pluginResults: PluginStartupResult[] = [];\n  const moduleResultsByPlugin: Map<string, ModuleStartupResult[]> = new Map(\n    Array.from(starting).map(pluginId => [pluginId, []]),\n  );\n\n  logger?.info(`Plugin initialization started: ${joinIds(starting)}`);\n\n  const getInitStatus = () => {\n    let status = '';\n    if (started.size > 0) {\n      status = `, newly initialized: ${joinIds(started)}`;\n      started.clear();\n    }\n    if (starting.size > 0) {\n      status += `, still initializing: ${joinIds(starting)}`;\n    }\n    return status;\n  };\n\n  // Periodically log the initialization status with a fibonacci backoff\n  let interval = 1000;\n  let prevInterval = 0;\n  let timeout: NodeJS.Timeout | undefined;\n  const onTimeout = () => {\n    logger?.info(`Plugin initialization in progress${getInitStatus()}`);\n\n    const nextInterval = Math.min(interval + prevInterval, LOGGER_INTERVAL_MAX);\n    prevInterval = interval;\n    interval = nextInterval;\n\n    timeout = setTimeout(onTimeout, nextInterval);\n  };\n  timeout = setTimeout(onTimeout, interval);\n\n  return {\n    onPluginResult(pluginId: string, error?: Error) {\n      starting.delete(pluginId);\n      started.add(pluginId);\n\n      const modules = moduleResultsByPlugin.get(pluginId);\n      if (!modules) {\n        throw new Error(\n          `Failed to push plugin result for nonexistent plugin '${pluginId}'`,\n        );\n      }\n\n      if (!error) {\n        pluginResults.push({\n          pluginId,\n          resultAt: new Date(),\n          modules,\n        });\n      } else {\n        const allowed = options.allowBootFailurePredicate(pluginId);\n        pluginResults.push({\n          pluginId,\n          resultAt: new Date(),\n          modules,\n          failure: {\n            error,\n            allowed,\n          },\n        });\n        if (allowed) {\n          logger?.error(\n            `Plugin '${pluginId}' threw an error during startup, but boot failure is permitted for this plugin so startup will continue.`,\n            error,\n          );\n        } else {\n          hasDisallowedFailures = true;\n          const status =\n            starting.size > 0\n              ? `, waiting for ${starting.size} other plugins to finish before shutting down the process`\n              : '';\n          logger?.error(\n            `Plugin '${pluginId}' threw an error during startup${status}.`,\n            error,\n          );\n        }\n      }\n    },\n    onPluginModuleResult(pluginId: string, moduleId: string, error?: Error) {\n      const moduleResults = moduleResultsByPlugin.get(pluginId);\n      if (!moduleResults) {\n        throw new Error(\n          `Failed to push module result for nonexistent plugin '${pluginId}'`,\n        );\n      }\n\n      if (!error) {\n        moduleResults.push({ moduleId, resultAt: new Date() });\n      } else {\n        const allowed = options.allowBootFailurePredicate(pluginId, moduleId);\n        moduleResults.push({\n          moduleId,\n          resultAt: new Date(),\n          failure: { error, allowed },\n        });\n        if (allowed) {\n          logger?.error(\n            `Module ${moduleId} in Plugin '${pluginId}' threw an error during startup, but boot failure is permitted for this plugin module so startup will continue.`,\n            error,\n          );\n        } else {\n          hasDisallowedFailures = true;\n          const status =\n            starting.size > 0\n              ? `, waiting for ${starting.size} other plugins to finish before shutting down the process`\n              : '';\n          logger?.error(\n            `Module ${moduleId} in Plugin '${pluginId}' threw an error during startup${status}.`,\n            error,\n          );\n        }\n      }\n    },\n    finalize() {\n      logger?.info(`Plugin initialization complete${getInitStatus()}`);\n\n      if (timeout) {\n        clearTimeout(timeout);\n        timeout = undefined;\n      }\n      return {\n        beginAt,\n        resultAt: new Date(),\n        outcome: hasDisallowedFailures ? 'failure' : 'success',\n        plugins: pluginResults,\n      };\n    },\n  };\n}\n"],"names":[],"mappings":"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"}
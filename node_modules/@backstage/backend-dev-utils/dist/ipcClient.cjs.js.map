{"version":3,"file":"ipcClient.cjs.js","sources":["../src/ipcClient.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\ntype SendMessage = Exclude<typeof process.send, undefined>;\n\ninterface Request {\n  id: number;\n  method: string;\n  body: unknown;\n  type: string;\n}\n\ntype Response =\n  | {\n      type: string;\n      id: number;\n      body: unknown;\n    }\n  | {\n      type: string;\n      id: number;\n      error: Error;\n    };\n\ntype ResponseHandler = (response: Response) => void;\n\nconst requestType = '@backstage/cli/channel/request';\nconst responseType = '@backstage/cli/channel/response';\n\nconst IPC_TIMEOUT_MS = 5000;\n\n/**\n * The client side of an IPC communication channel.\n *\n * @internal\n */\nexport class BackstageIpcClient {\n  #messageId = 0;\n  #sendMessage: SendMessage;\n  #handlers: Map<number, ResponseHandler> = new Map();\n\n  /**\n   * Creates a new client if we're in a child process with IPC and BACKSTAGE_CLI_CHANNEL is set.\n   */\n  static create(): BackstageIpcClient | undefined {\n    const sendMessage = process.send?.bind(process);\n    const client =\n      sendMessage && process.env.BACKSTAGE_CLI_CHANNEL\n        ? new BackstageIpcClient(sendMessage)\n        : undefined;\n\n    if (client) {\n      process.on('message', (message, _sendHandle) =>\n        client.handleMessage(message, _sendHandle),\n      );\n    }\n\n    return client;\n  }\n\n  constructor(sendMessage: SendMessage) {\n    this.#sendMessage = sendMessage;\n  }\n\n  private handleMessage(message: unknown, _sendHandle: unknown) {\n    const isResponse = (msg: unknown): msg is Response =>\n      (msg as Response)?.type === responseType;\n\n    if (isResponse(message)) {\n      this.#handlers.get(message.id)?.(message);\n    }\n  }\n\n  /**\n   * Send a request to the parent process and wait for a response.\n   */\n  async request<TRequestBody, TResponseBody>(\n    method: string,\n    body: TRequestBody,\n  ): Promise<TResponseBody> {\n    return new Promise((resolve, reject) => {\n      const id = this.#messageId++;\n\n      const request: Request = {\n        type: requestType,\n        id,\n        method,\n        body,\n      };\n\n      let timeout: NodeJS.Timeout | undefined = undefined;\n\n      const responseHandler: ResponseHandler = (response: Response) => {\n        clearTimeout(timeout);\n        timeout = undefined;\n        this.#handlers.delete(id);\n\n        if ('error' in response) {\n          const error = new Error(response.error.message);\n          if (response.error.name) {\n            error.name = response.error.name;\n          }\n          reject(error);\n        } else {\n          resolve(response.body as TResponseBody);\n        }\n      };\n\n      timeout = setTimeout(() => {\n        reject(new Error(`IPC request '${method}' with ID ${id} timed out`));\n        this.#handlers.delete(id);\n      }, IPC_TIMEOUT_MS);\n      timeout.unref();\n\n      this.#handlers.set(id, responseHandler);\n      this.#sendMessage(request, undefined, undefined, (e: Error | null) => {\n        if (e) {\n          reject(e);\n        }\n      });\n    });\n  }\n}\n\nexport const ipcClient = BackstageIpcClient.create();\n"],"names":[],"mappings":"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"}
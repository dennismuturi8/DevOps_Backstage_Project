{"version":3,"file":"useLogViewerSelection.esm.js","sources":["../../../src/components/LogViewer/useLogViewerSelection.tsx"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { errorApiRef, useApi } from '@backstage/core-plugin-api';\nimport { useEffect, useState } from 'react';\nimport useCopyToClipboard from 'react-use/esm/useCopyToClipboard';\nimport { AnsiLine } from './AnsiProcessor';\n\ntype Selection = {\n  start: number;\n  end: number;\n};\n\nexport function useLogViewerSelection(lines: AnsiLine[]) {\n  const errorApi = useApi(errorApiRef);\n  const [selections, setSelections] = useState<Selection[]>([]);\n\n  const [{ error }, copyToClipboard] = useCopyToClipboard();\n\n  useEffect(() => {\n    if (error) {\n      errorApi.post(error);\n    }\n  }, [error, errorApi]);\n\n  const findClosestSelection = (\n    allSelections: Selection[],\n    line: number,\n  ): Selection | undefined => {\n    if (selections.length === 0) {\n      return undefined;\n    }\n    let minDistance = Number.MAX_SAFE_INTEGER;\n    let closestSelection: Selection | undefined = undefined;\n\n    allSelections.forEach(s => {\n      const distance = Math.min(\n        Math.abs(s.start - line),\n        Math.abs(s.end - line),\n      );\n      if (distance < minDistance) {\n        minDistance = distance;\n        closestSelection = s;\n      }\n    });\n\n    return closestSelection;\n  };\n\n  const mergeNeighbouringSelections = (\n    allSelections: Selection[],\n    line: number,\n  ): Selection[] => {\n    // Merge selections if they're next to each other\n    const neighboringSelections = allSelections.filter(\n      s => s.start - 1 === line || s.end + 1 === line,\n    );\n    if (neighboringSelections.length === 0) {\n      return allSelections;\n    }\n    const newSelection = {\n      start: Math.min(line, ...neighboringSelections.map(s => s.start)),\n      end: Math.max(line, ...neighboringSelections.map(s => s.end)),\n    };\n\n    return [\n      ...allSelections.filter(\n        s =>\n          !neighboringSelections.includes(s) &&\n          !(s.start === line && s.end === line),\n      ),\n      newSelection,\n    ];\n  };\n\n  return {\n    shouldShowCopyButton(line: number) {\n      // show copy button at the beginning of each selection\n      return selections.some(s => s.start === line);\n    },\n    isSelected(line: number) {\n      if (!selections) {\n        return false;\n      }\n      // check if line is in any selection range\n      return selections.some(\n        s => s.start <= line && (s.end ?? s.start) >= line,\n      );\n    },\n    setSelection(line: number, addRange: boolean, addNewSelection: boolean) {\n      setSelections(currentSelections => {\n        const clickedSelection = currentSelections.find(\n          s => s.start <= line && s.end >= line,\n        );\n        const otherSelections = currentSelections.filter(\n          s => s !== clickedSelection,\n        );\n\n        if (!addRange && !addNewSelection) {\n          // Normal click -> select only this line if nothing or multiple lines are selected\n          if (\n            !clickedSelection ||\n            clickedSelection.start !== clickedSelection.end\n          ) {\n            return [{ start: line, end: line }];\n          }\n          // Clear selection if single line is selected\n          return [];\n        }\n\n        if (addRange) {\n          // Shift+click -> extend/reduce selection\n          if (currentSelections.length === 0) {\n            // No existing selection -> create new selection\n            return [{ start: line, end: line }];\n          }\n\n          if (clickedSelection) {\n            // Clicked inside an existing selection -> reduce selection\n            if (clickedSelection.start === clickedSelection.end) {\n              // Single line selection -> remove it\n              return otherSelections;\n            }\n            // Reduce selection\n            return [\n              ...otherSelections,\n              { start: clickedSelection.start, end: line },\n            ];\n          }\n\n          // Extend the closest selection to the new line\n          const closestSelection = findClosestSelection(\n            currentSelections,\n            line,\n          );\n          if (!closestSelection) {\n            // Can't actually happen\n            return currentSelections;\n          }\n          if (closestSelection.start < line) {\n            // Add lines before the selection\n            return mergeNeighbouringSelections(\n              [\n                ...otherSelections.filter(s => s !== closestSelection),\n                { start: closestSelection.start, end: line },\n              ],\n              line,\n            );\n          }\n          // Add lines after the selection\n          return mergeNeighbouringSelections(\n            [\n              ...otherSelections.filter(s => s !== closestSelection),\n              { start: line, end: closestSelection!.end },\n            ],\n            line,\n          );\n        }\n\n        if (addNewSelection) {\n          // Ctrl/Cmd+click -> add new selection\n          if (!clickedSelection) {\n            // Just add new selection\n            return mergeNeighbouringSelections(\n              [...currentSelections, { start: line, end: line }],\n              line,\n            );\n          }\n          if (clickedSelection.start === clickedSelection.end) {\n            // Single line selection -> remove it\n            return otherSelections;\n          }\n          // Multi line selection -> split it\n          return [\n            ...otherSelections,\n            ...(clickedSelection.start < line\n              ? [{ start: clickedSelection.start, end: line - 1 }]\n              : []),\n            ...(clickedSelection.end > line\n              ? [{ start: line + 1, end: clickedSelection.end }]\n              : []),\n          ];\n        }\n\n        return [];\n      });\n    },\n    copySelection(line: number) {\n      const selection = selections.find(s => s.start === line);\n      if (!selection) {\n        return;\n      }\n      const copyText = lines\n        .slice(selection.start - 1, selection.end)\n        .map(l => l.chunks.map(c => c.text).join(''))\n        .join('\\n');\n      copyToClipboard(copyText);\n    },\n    getHash() {\n      if (selections.length === 0) {\n        return '';\n      }\n      const parts = selections.map(s => {\n        if (s.start === s.end) {\n          return `${s.start}`;\n        }\n        return `${s.start}-${s.end}`;\n      });\n      return `#lines-${parts.join(',')}`;\n    },\n    selectAll(hash: string) {\n      const match = hash.match(/#lines-([\\d,-]+)/);\n      const s: Selection[] = [];\n      if (match) {\n        const ranges = match[1].split(',');\n        ranges.forEach(r => {\n          const [start, end] = r.split('-').map(Number);\n          s.push({ start, end: end ?? start });\n        });\n      }\n      setSelections(s);\n    },\n  };\n}\n"],"names":[],"mappings":"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"}
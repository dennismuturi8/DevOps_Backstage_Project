{"version":3,"file":"createAllowBootFailurePredicate.cjs.js","sources":["../../src/wiring/createAllowBootFailurePredicate.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Config } from '@backstage/config';\n\nexport type AllowBootFailurePredicate = (\n  pluginId: string,\n  moduleId?: string,\n) => boolean;\n\n/**\n * Creates a predicate function that determines whether a boot failure should be\n * allowed for a given plugin or module based on configuration.\n *\n * @param config - The configuration object to read boot failure settings from\n * @returns A predicate function that accepts a pluginId and optional moduleId,\n *          and returns true if boot failures should be allowed, false otherwise.\n */\nexport function createAllowBootFailurePredicate(\n  config?: Config,\n): AllowBootFailurePredicate {\n  // Read default values upfront\n  const defaultPluginBootFailure =\n    config?.getOptionalString('backend.startup.default.onPluginBootFailure') ??\n    'abort';\n  const defaultModuleBootFailure =\n    config?.getOptionalString(\n      'backend.startup.default.onPluginModuleBootFailure',\n    ) ?? 'abort';\n\n  // Read plugin-specific overrides upfront\n  const pluginOverrides = new Map<string, string>();\n  const moduleOverrides = new Map<string, Map<string, string>>();\n\n  const pluginsConfig = config?.getOptionalConfig('backend.startup.plugins');\n  if (pluginsConfig) {\n    for (const pluginId of pluginsConfig.keys()) {\n      const pluginConfig = pluginsConfig.getConfig(pluginId);\n      const pluginBootFailure = pluginConfig.getOptionalString(\n        'onPluginBootFailure',\n      );\n      if (pluginBootFailure) {\n        pluginOverrides.set(pluginId, pluginBootFailure);\n      }\n\n      // Read module-specific overrides\n      const modulesConfig = pluginConfig.getOptionalConfig('modules');\n      if (modulesConfig) {\n        const moduleMap = new Map<string, string>();\n        for (const moduleId of modulesConfig.keys()) {\n          const moduleConfig = modulesConfig.getConfig(moduleId);\n          const moduleBootFailure = moduleConfig.getOptionalString(\n            'onPluginModuleBootFailure',\n          );\n          if (moduleBootFailure) {\n            moduleMap.set(moduleId, moduleBootFailure);\n          }\n        }\n        if (moduleMap.size > 0) {\n          moduleOverrides.set(pluginId, moduleMap);\n        }\n      }\n    }\n  }\n\n  return (pluginId: string, moduleId?: string): boolean => {\n    if (moduleId !== undefined) {\n      // Module-specific boot failure predicate\n      const moduleMap = moduleOverrides.get(pluginId);\n      const moduleBootFailure =\n        moduleMap?.get(moduleId) ?? defaultModuleBootFailure;\n      return moduleBootFailure === 'continue';\n    }\n    // Plugin-specific boot failure predicate\n    const pluginBootFailure =\n      pluginOverrides.get(pluginId) ?? defaultPluginBootFailure;\n    return pluginBootFailure === 'continue';\n  };\n}\n"],"names":[],"mappings":";;AA+BO,SAAS,gCACd,MAAA,EAC2B;AAE3B,EAAA,MAAM,wBAAA,GACJ,MAAA,EAAQ,iBAAA,CAAkB,6CAA6C,CAAA,IACvE,OAAA;AACF,EAAA,MAAM,2BACJ,MAAA,EAAQ,iBAAA;AAAA,IACN;AAAA,GACF,IAAK,OAAA;AAGP,EAAA,MAAM,eAAA,uBAAsB,GAAA,EAAoB;AAChD,EAAA,MAAM,eAAA,uBAAsB,GAAA,EAAiC;AAE7D,EAAA,MAAM,aAAA,GAAgB,MAAA,EAAQ,iBAAA,CAAkB,yBAAyB,CAAA;AACzE,EAAA,IAAI,aAAA,EAAe;AACjB,IAAA,KAAA,MAAW,QAAA,IAAY,aAAA,CAAc,IAAA,EAAK,EAAG;AAC3C,MAAA,MAAM,YAAA,GAAe,aAAA,CAAc,SAAA,CAAU,QAAQ,CAAA;AACrD,MAAA,MAAM,oBAAoB,YAAA,CAAa,iBAAA;AAAA,QACrC;AAAA,OACF;AACA,MAAA,IAAI,iBAAA,EAAmB;AACrB,QAAA,eAAA,CAAgB,GAAA,CAAI,UAAU,iBAAiB,CAAA;AAAA,MACjD;AAGA,MAAA,MAAM,aAAA,GAAgB,YAAA,CAAa,iBAAA,CAAkB,SAAS,CAAA;AAC9D,MAAA,IAAI,aAAA,EAAe;AACjB,QAAA,MAAM,SAAA,uBAAgB,GAAA,EAAoB;AAC1C,QAAA,KAAA,MAAW,QAAA,IAAY,aAAA,CAAc,IAAA,EAAK,EAAG;AAC3C,UAAA,MAAM,YAAA,GAAe,aAAA,CAAc,SAAA,CAAU,QAAQ,CAAA;AACrD,UAAA,MAAM,oBAAoB,YAAA,CAAa,iBAAA;AAAA,YACrC;AAAA,WACF;AACA,UAAA,IAAI,iBAAA,EAAmB;AACrB,YAAA,SAAA,CAAU,GAAA,CAAI,UAAU,iBAAiB,CAAA;AAAA,UAC3C;AAAA,QACF;AACA,QAAA,IAAI,SAAA,CAAU,OAAO,CAAA,EAAG;AACtB,UAAA,eAAA,CAAgB,GAAA,CAAI,UAAU,SAAS,CAAA;AAAA,QACzC;AAAA,MACF;AAAA,IACF;AAAA,EACF;AAEA,EAAA,OAAO,CAAC,UAAkB,QAAA,KAA+B;AACvD,IAAA,IAAI,aAAa,MAAA,EAAW;AAE1B,MAAA,MAAM,SAAA,GAAY,eAAA,CAAgB,GAAA,CAAI,QAAQ,CAAA;AAC9C,MAAA,MAAM,iBAAA,GACJ,SAAA,EAAW,GAAA,CAAI,QAAQ,CAAA,IAAK,wBAAA;AAC9B,MAAA,OAAO,iBAAA,KAAsB,UAAA;AAAA,IAC/B;AAEA,IAAA,MAAM,iBAAA,GACJ,eAAA,CAAgB,GAAA,CAAI,QAAQ,CAAA,IAAK,wBAAA;AACnC,IAAA,OAAO,iBAAA,KAAsB,UAAA;AAAA,EAC/B,CAAA;AACF;;;;"}